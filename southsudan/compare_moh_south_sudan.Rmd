---
title: "Comparing South Sudan Health facility location data from different sources"
#output: html_document
author: "Andy South @afrimapr"
date: "`r Sys.Date()`"
output: pdf_document
always_allow_html: true
---

DRAFT
[Code for this document](https://github.com/afrimapr/afrimapr_dev/blob/master/compare_moh_southsudan.Rmd)

We currently have access to the following sources of health facility locations for South Sudan.

1. downloaded from Ministry of Health website [https://www.southsudanhealth.info/](https://www.southsudanhealth.info/)
1. healthsites.io in OpenStreetMap
1. [South Sudan Health Service Functionality Dashboard](https://southsudanhsf.shinyapps.io/hsf_dashboard/) (locations not downloadable)
1. collated data from published paper Maina(2019) 

Numbers of locations per source.

source  | number facilities | spatial data | useful attributes
------------ | ---------- | ------------------ | ------------------
1. MoH     |  2889 | coords (2553 with, 336 without) |  Facility codes in 'Ext Ref' e.g. FC05040202
2. OSM/healthsites    | 432 | coords | (few complete) beds,staff_doctors,staff nurses
3. Health Service Functionality Dashboard | 1890 | not downloadable, (1671 with coords, 219 without) | lots e.g. functionality

The downloadable MoH data do not seem to have changed in the last year.

The Functionality Dashboard says this about the data displayed there : "Facility data for this bulletin was kindly contributed by the Health Cluster partners, Health Pooled Fund (HPF), the International Committee of the Red Cross (ICRC), Management Sciences International (MSI), UNICEF, and UNHCR. Additional service availability data was extracted from the Ministry of Health DHIS2 platform for facilities without an implementing partner report. Most data was reported as of 31 March 2020, but the report date for each facility is indicated by hovering over a facility marker on the map. Implementing partners self-report on a quarterly basis service availability based predefined, standardized service availability data points and definitions. WHO merges the respective data sets and assigns a functionality level to each facility based on the criteria below."

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(afrihealthsites)
library(knitr) #for kable
library(dplyr)
library(ggplot2)

```


```{r, eval=TRUE, include=FALSE, warning=FALSE}


# read in files
filemoh <- "data-raw\\south_sudan_facility_info_2020-05-13.csv"
dfssd <- read.csv(filemoh, as.is=TRUE, check.names=FALSE)


#ssudan has a single location column containing coords divided by commas as strings 
# fair few coords at null island 0,0
# seemingly some NAs, or maybe problem with me trying to pass single Location rather than 2 columns
#which(is.na(dfssudan$Location))
#sfssudan <- sf::st_as_sf(dfssudan, coords='Location')

#dfs <- head(dfssudan)

#divide into 2 columns
dfcoords <- as.data.frame(stringr::str_split(dfssd$Location,", ",simplify=TRUE), stringsAsFactors = FALSE)
#change to numeric
dfcoords <- lapply(dfcoords,as.numeric)
#name columns
#names(dfcoords) <- c("Longitude", "Latitude")
names(dfcoords) <- c("Latitude", "Longitude")
#bind back onto df
dfssd <- cbind(dfssd, dfcoords)

sfssd <- sf::st_as_sf(dfssd, coords=c("Longitude", "Latitude"), crs = 4326)

#mapview::mapview(sfssd)

# I can add a 4 Tier classification here
# add Tier 0 for unknown
# TODO how best to do lookup ?
# I'm tired this is a daft way of doing but works
# I could put something into a function in afrihealhsites instead
unique(sfssd$type) 
#  [1] "Other"                        "Primary Health Care Centre"   "Primary Health Care Unit"    
#  [4] "County Hospital"              "County Health Department"     "State Hospital"              
#  [7] "Specialized Hospital/Clinic"  "Teaching Hospital"            "Health Training Institutions"
# [10] "Ministry of Health"    


# tiers <- afrihealthsites::tiers4(sfssd$type,
#                                  tier1=c("Primary Health Care Unit"),
#                                  tier2=c("Primary Health Care Centre"),                                 
#                                  to_return = "Tier_name"
#                                  )
# 
# sfssd$Tier_name <- tiers

# moh_tier_lookup_pre <- data.frame("Other"=0,
#                                   "Primary Health Care Centre"=2,
#                                   "Primary Health Care Unit"=1)
# 
# moh_tier_lookup <- as.data.frame(t(moh_tier_lookup_pre))

#tst <- as.data.frame(t(data.frame("a"="b","c"="d")))
#tst$x <- rownames(tst)

#match returns a vector of the positions of (first) matches of its first argument in its second.
#sftogo$facility_type_9 <- who_type_lookup$facility_type_9[ match(sftogo$`Facility type`,who_type_lookup$type_who) ]



# df_who_sites$Tier_name <- ifelse(df_who_sites$Tier==1,"Tier1 health post",
#                             ifelse(df_who_sites$Tier==2,"Tier2 health center",
#                             ifelse(df_who_sites$Tier==3,"Tier3 provincial hospital",
#                             ifelse(df_who_sites$Tier==4,"Tier4 central hospital", NA))))


#save
save(sfssd, file="sfssd.rda")

```


```{r map_moh_ssudan, eval=FALSE, include=FALSE, warning=FALSE}

# 2889 obs

# just view MoH data
sfmoh <- afrihealthsites("South Sudan", datasource=ssudan_file, lonlat_columns = "Location")

sfmoh <- afrihealthsites("South Sudan", datasource=sfssd,                              
                         type_column = 'type',
                         label_column = 'Facility')


# plot moh vs kemri on a map
# afrihealthsites::compare_hs_sources("south sudan", datasources=c('who',ssudan_file))

# most overlap but not total


```


```{r moh_type_frequencies, echo=FALSE, warnings=FALSE, asis=TRUE, fig.width=9, fig.height=6}

# Plot counts of facility types from MoH data

# pass the sf object directly
ggssd <- facility_types("south sudan", 
                        datasource=sfssd,
                        type_column = "type",
                        plot_title="Facility types in South Sudan MoH data",
                        plot=FALSE)
plot(ggssd)



```

```{r, eval=TRUE, echo=FALSE, warning=FALSE, asis=TRUE, fig.width=9, fig.height=4}

# facility data (no coords) copied from WHO/MOH health service functionality (hsf) dashboard
# 

# read in files
filehsf <- "data-raw\\2021-05-ssd-hsfdashboard-copy.csv"
dfhsf <- read.csv(filehsf, as.is=TRUE, check.names=FALSE)

gghsf <- facility_types("south sudan", 
                        datasource=dfhsf,
                        type_column = "Facility type",
                        lonlat_columns = NULL,
                        plot_title="Facility types, Health Service Functionality data (no coords)",
                        plot=FALSE)
plot(gghsf)


```


```{r moh_missing_coords, echo=FALSE, warning=FALSE, asis=TRUE, fig.width=9, fig.height=6}


sfssdnocoords <- sfssd[which(sfssd$Location=="0.00000, 0.00000"),] 
sfssdcoords <- sfssd[which(sfssd$Location!="0.00000, 0.00000"),] 

# types for those without coords
ggssd <- facility_types("south sudan", 
                        datasource=sfssdnocoords,
                        type_column = "type",
                        plot_title="336 Facilities in the MoH data with no coordinates",
                        plot=FALSE)
plot(ggssd)


```


# TODO start to do subset analysis for Central Equatoria (incl. Juba)

