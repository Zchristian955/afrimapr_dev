---
title: "covid-hera-hdx-explore"
output: html_document
---
  
# HERA on HDX have various subnational covid data for ~16 African countries
# starting to explore them  
# can potentially use as case study for data joining
  
https://data.humdata.org/organization/hera-humanitarian-emergency-response-africa?


searched for this on github to see if anyone has solved these issues already, but seemingly not
subnational_covid19_hera


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#todo add afriadmin

library(dplyr)
library(ggplot2)
library(readr)
library(sf)

#using new path specification avoiding double slashes
folder <- r"(C:\Dropbox\_afrimapr\data\covid-hera-hdx\)"

```


```{r, hera-tgo, eval=TRUE, warning=FALSE}

dftgo <- readr::read_csv2(r"(C:\Dropbox\_afrimapr\data\covid-hera-hdx\tgo_subnational_covid19_hera.csv)")

head(dftgo)

#      ID DATE  ISO_3 PAYS  ID_PAYS REGION ID_REGION CONTAMINES DECES GUERIS CONTAMINES_FEMME
#   <dbl> <chr> <chr> <chr>   <dbl> <chr>      <dbl> <chr>      <chr> <chr>  <chr>           
# 1     1 06/0~ TGO   Togo        3 Centre        22 0          0     0      0               
# 2     2 06/0~ TGO   Togo        3 Kara          21 0          0     0      0               
# 3     3 06/0~ TGO   Togo        3 Marit~        24 1          0     0      1 

#REGION column contains region names

unique(dftgo$REGION)

# "Centre"       "Kara"         "Maritime"     "Plateaux"     "Savanes"      "Non spécifié"

sftgoadm1 <- afriadmin::afriadmin('tgo',level=1)

unique(sftgoadm1$shapeName)

#"Savanes Region"  "Kara Region"     "Centrale Region" "Plateaux Region" "Maritime Region"

#so to join will need to remove Region from geoboundaries & change some names eg centre v centrale

```


```{r, hera-bfa, eval=TRUE, warning=FALSE}

#dfbfaold <- readr::read_csv2(r"(C:\Dropbox\_afrimapr\data\covid-hera-hdx\bfa_subnational_covid19_hera.csv)")
dfbfa <- readr::read_csv2(r"(C:\Dropbox\_afrimapr\data\covid-hera-hdx\bfa_subnational_covid19_hera.csv)",
                          col_types='iccciciiiiiiicc')
#D for date didn't work on the way the date is formatted

library(lubridate)

dfbfa$date <- lubridate::dmy(dfbfa$DATE)

head(dfbfa)
#      ID DATE  ISO_3 PAYS  ID_PAYS REGION ID_REGION CONTAMINES DECES GUERIS CONTAMINES_FEMME
#   <dbl> <chr> <chr> <chr>   <dbl> <chr>      <dbl> <chr>      <chr> <chr>  <chr>           
# 1     1 09/0~ BFA   Burk~      16 Boucl~       208 0          0     0      0  

#not needed once column types specified in read_csv
#dfbfa$CONTAMINES <- as.numeric(dfbfa$CONTAMINES)


unique(dfbfa$REGION)

#  [1] "Boucle du Mouhoun" "Cascades"          "Centre"            "Centre-Est"        "Centre-Nord"    
#  [6] "Centre-Ouest"      "Centre-Sud"        "Est"               "Haut-Bassins"      "Nord"           
# [11] "Plateau-Central"   "Sahel"             "Sud-Ouest"         "Non spécifié"     

sfbfaadm1 <- afriadmin::afriadmin('bfa',level=1)

unique(sfbfaadm1$shapeName)

#  [1] "Centre"            "Boucle du Mouhoun" "Cascades"          "Centre-Est"        "Centre-Nord"    
#  [6] "Centre-Ouest"      "Centre-Sud"        "Est"               "Hauts-Bassins"     "Nord"           
# [11] "Plateau Central"   "Sahel"             "Sud-Ouest"  

# cool these match better than togo, except for Hauts-Bassins != Haut-Bassins
# Plateau-Central != Plateau Central
# good case studies of things to match

# explore dfbfa
length(unique(dfbfa$DATE))
#216

#I wonder if fuzzyjoin works to join the data to the admin areas map ?
library(fuzzyjoin)

# cool the antijoin gets no results
# seems to suggest the inner join will catch all

fuzzyjoin::stringdist_anti_join(sfbfaadm1,dfbfa, by=c(shapeName = 'REGION')) 
#Simple feature collection with 0 features and 5 fields

sf1 <- fuzzyjoin::stringdist_inner_join(sfbfaadm1,dfbfa, by=c(shapeName = 'REGION')) 
# convert back to sf after fuzzyjoin
sf1 <- st_as_sf(sf1)

#plotting in tmap, maybe faceting by date, will need to be careful that in date order

# works but with 216 cells can't read date legend to see if in correct order
# tmap::tm_shape(sf1) +
#     tm_polygons("CONTAMINES") +
#     tm_facets(by = "date") #date is the formatted date column

# aggregate by month or week, using lubridate::floor_date
# first go just sum the results
# sfmonthly <- sf1 %>% group_by(month=floor_date(date, "month"),
#                               REGION=REGION) %>%
#    summarize(CONTAMINES=sum(CONTAMINES))

#calculate weekly totals
sfweekly <- sf1 %>% group_by(week=floor_date(date, "week"),
                             REGION=REGION) %>%
   summarize(CONTAMINES=sum(CONTAMINES,na.rm=TRUE))

#nice weekly facetted map
tmap::tm_shape(sfweekly) +
    tm_polygons("CONTAMINES") +
    tm_facets(by = "week") 


```

Can I also get to the data through rhdx ?

